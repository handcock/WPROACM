
# Everything that gets displayed inside the app is enclosed in a call to `shinyUI`.
# The first thing to be specified is the type of page to display. The `navbarPage`
# includes a navigation bar at the top of the page and each tab leads to different
# pages of content.

shinyUI(
  navbarPage(
    #theme="mycosmo.css",
    title=NULL,
    id= 'navbar', windowTitle = 'WPROACM', collapsible=TRUE,



# Front Page (About) ------------------------------------------------------


tabPanel(title=span('WPROACM', id="sWtitle"),
         value='tab1',
         fluidRow(
          column(2,
                 actionButton("aboutButton", label = "About WPROACM",
                              class = "btn active"),
    #            actionButton("citeButton", label = "Citing WPROACM",
    #                         class = "btn"),
                 actionButton('startButton', label='Get Started',
                              class="btn btn-primary"),
                 fluidRow(column(1,
                  a(img(src = 'WHOWPRO.png', width = 175),
                    href = 'https://www.who.int/westernpacific/', target = '_blank') ))
          ),
   column(6, style="padding: 0 30px 0 0;",
          div(id="aboutbox",
            p("Welcome to the",strong("WPRO online-calculator for excess deaths in countries"),"!"),

            p("This calculator has been developed by the", a('World Health Organization, Western Pacific Region',
                href='https://www.who.int/westernpacific/',
               target='_blank'), "in conjunction with the", a('Department of Statistics at UCLA',
                href='http://statistics.ucla.edu/', target='_blank'),"."),

            p("This tool aims to estimate the",em("expected all-cause mortality"),"counts for each week or month starting at",
              "January 1, 2020 onward in the counter-factual situation where there had not been a pandemic.",
              "Monitoring the all-cause mortality trends is an important component of multisource surveillance for COVID-19.",
              "The",em("excess mortality"),"is defined to be the difference between the reported counts and expected counts for that week or month.",
              "in the Western Pacific region"),

            p("This interface is useful as part of the dialogue between the WHO WPRO and countries about the",
              "impact of the COVID-19 pandemic on all-cause mortality (ACM) in individual Member countries and territories",
              "in the Western Pacific region"),

            p("Tracking all-cause mortality trends is an important component of multisource surveillance for COVID-19.",
              "Excess deaths have been observed in several countries during the COVID19 pandemic.",
              "Evidence is needed to support timely and dynamic decision-making and policy development."),

            p("This tool will allow easy tracking and analysis of ACM and excess deaths.",
              "It is for use by member countries and does not require the data to be seen by the WHO WPRO.",
              "In fact, all analysis is done on the computer where it is run. An internet connection is only required",
              "to install the software (already done if you are reading this message!)."),

            p("A typical analysis will move sequentially through the tabs at the top of the page",
              "(starting with", actionLink("startButton", "Get Started"),".",
              "Click on the help icon at the top of any page for guidance."),
            p("Bug Reports/comments/suggestions/requests? Please share them with us.",
              "They are best submitted through our", a('GitHub site,',
                                                       href='https://github.com/handcock/WPROACM',
                                                       target='_blank'),
              "or by email to us (see", actionLink("helpLink", "Help"), "tab)."),
            p("This web application",
              "is written with the Shiny framework and development is via GitHub.  More information",
              "on Shiny and our GitHub repository can be found in the",
              "resource links on the right.")
          ),
          div(id="citebox",
            tabsetPanel(
              tabPanel("BibTeX",
p(strong("WPROACM")),
tags$pre(id='scitation','@Manual{handcock:WPROACM,
  title = {WPROACM: Software tools for the Statistical Analysis of Excess Mortality from All Cause Mortality Data
  author = {Mark S. Handcock},
  year = {2021},
  address = {Los Angeles, CA},
  url = {http://hpmrg.org/}
}'),

p(strong("WPROACM")),
tags$pre(id='swcitation',"@Manual{beylerian:WPROACM,
  title = {\\pkg{WPROACM}: A Graphical User Interface for Analysing Excess Mortality from All Cause Mortality Data},
  author = {Mark S. Handcock},
  year = {2021},
  note = {\\proglang{R}~package version~0.1},
  address = {Los Angeles, CA},
  url = {https://cran.r-project.org/web/packages/WPROACM/}
}")
                       ),
              tabPanel("Other",
p(strong("WPROACM")),
tags$pre("Mark S. Handcock (2021). WPROACM: A Graphical User Interface for Analysing Excess Mortality from All Cause Mortality Data. URL http://hpmrg.org"),

p(strong("WPROACM")),
tags$pre("Mark S. Handcock (2021).
WPROACM: A Graphical User Interface for Analysing Excess Mortality from All Cause Mortality Data.")
                       )
            ),

            p('If you use WPROACM, please cite it'),
            )
          ),
   column(4,
          wellPanel(
              h5(tags$u('Resources')),
              div(a("WPROACM on GitHub", href="https://github.com/handcock/WPROACM",
                    target="_blank")),
              div(a("Shiny: a web application framework for R", href="http://shiny.rstudio.com/",
                    target="_blank"))
   ),
   fluidRow(a(img(src = 'UCLADepartmentofStatisticsSmall.png', width = 400),
             href = 'http://statistics.ucla.edu/', target = '_blank'),
             style="margin-left:15px;")
   )
   )
 ),


# Data Upload -------------------------------------------------------------


# Before the code for what is displayed on the Data Upload page,
# various javaScript and CSS files that will be useful later in the
# script are linked. For example, since network plotting and model
# fitting do not happen instantly (especially for large networks),
# a loading icon will help to assure users that the app is still working
# on producing output. The file busy.js controls the behavior of the
# loading message and style.css controls the appearance. To display
# the loading message on subsequent tabs, we only need to include the
# div statement within those tabs.

tabPanel(title='Data', value='tab2',
         #busy.js is for calculation in progress boxes
         #alert.js is for popup boxes,
         #jquery libraries are loaded from google cdn, needed for autocomplete
         #this tagList command has to go inside a tabPanel
         tagList(
           tags$head(
             tags$link(rel="stylesheet", type="text/css",href="style.css"),
             #tags$link(rel="stylesheet", type="text/css",href="autocomplete.css"),
             tags$link(rel="stylesheet", type="text/css",
                       href="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/themes/smoothness/jquery-ui.css"),
             tags$script(type="text/javascript", src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"),
             #tags$script(type="text/javascript", src="autocomplete.js"),
             tags$script(type="text/javascript", src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/jquery-ui.min.js"),
             tags$script(type="text/javascript", src="busy.js"),
             tags$script(type="text/javascript", src="alert.js"),
             tags$script(HTML('Shiny.addCustomMessageHandler("jsCode",
                              function(message) {
                              console.log(message)
                              eval(message.code);
                              });'))
           )
         ),

# Conditional panels are only displayed when a specified condition is true.
# The condition is a javascript expression that can refer to the current
# values of input or output objects. When the condition is false, the panel
# does not take up any space in the UI.


fluidRow(
  column(7,
    tabsetPanel(id='datatabs',
      tabPanel('Upload All Cause Mortality data', br(),
         wellPanel(
           fluidRow(
             column(6,
                    selectInput('filetype',label='File type',
                                 choices=c(
                                           'CSV spreadsheet of All Cause Mortality data (*.csv)' = 1,
                                           'built-in example All Cause Mortality data'= 2
                                          )
                    ),
             conditionalPanel(condition = 'input.filetype < 2',
               column(6,
                    br(),
                    fileInput(inputId='rawdatafile', label=NULL, accept='text'),
                    verbatimTextOutput('rawdatafile'))
                ),
             conditionalPanel(condition = 'input.filetype == 2',
                column(6,
                    br(style="line-height:26px;"),
                    selectizeInput('samplenet', label=NULL,
                                choices=c("Choose a country" = '', 
                                          'Australia','Japan',
                                          'South Korea', 'New Zealand', 'Philippines')),
                              p(class="helper", id="BIhelp", icon("question-circle"),
                                span("These are example CSV files from some countries with data from January 1, 2015 through August, 2020.", style="font-size:0.85em;"),
                                 br(),'You try select a country in the drop-down menu', em("Choose a country"),
                                 'above this message and view the data in the above', em("View Data"),' tab.',
                                 'You can then try the tool out on this data to see an analysis similar to that for your own country.')
                )
               )
             ),
             conditionalPanel(condition='input.filetype == 1',
                              p(class="helper", id="CSVhelp", icon("question-circle"),
                                span("What format does the CSV file need to be in?", style="font-size:0.85em;"),
                                 br(),'Upload a *csv file of all-cause mortality data.',
                                 'The file should be saved from the WHO standardized Excel template. Click', a("here",
                                  href = "https://www.who.int/westernpacific/", target = "_blank"), ' to download.')
                              )
           )),
         conditionalPanel(
           condition="input.filetype == 1 & input.samplenet != ''",
           wellPanel(uiOutput("datadesc"))
           )
         ),
    tabPanel('View Data', br(),
          div(id="aboutbox",
            p("Below is displayed the all cause of mortality data as read in. It should display column variables called 'COUNTRY','ISO3','YEAR'",
            "'PERIOD','SEX','AGE_GROUP','AREA','CAUSE','NO_DEATHS','DATE_TO_SPECIFY_WEEK','SE_IDENTIFIER'",
            "and few values should be missing (denoted NA). If your files does not look like this, try to load the built-in",
            "example All Cause Mortality data under the 'Upload All Cause Mortality data' tab on the top left. If you view that",
            "it will show what to expect."),
            p("If your data does not look correct, try to correct it in the WHO standardized Excel template. Click", a('here',
      href = 'https://www.who.int/westernpacific/', target = '_blank'), " to download."),
            p("A typical analysis will move sequentially through the tabs at the top of the page",
              "Click on the help icon at the top of any page for guidance."),
            p("If you are having trouble getting the data in",
              "email us (see", actionLink("helpLink", "Help"), "tab)."),
            ),
           wellPanel(
 #h3('Grocery List'),
 #uiOutput('Grocery_List')
#shiny::dataTableOutput("ACM_table")
dataTableOutput("ACM_table")
#DT::dataTableOutput('iris_table')
           )
         )
# tabPanel('Modify Attributes', br(),
#          wellPanel(
#            p('In the future we will build in functions that will ',
#              'allow you to modify the attributes of your network.',
#              'This will include options like:'),
#            tags$ul(
#              tags$li('Applying a function (e.g.', code('sqrt()'), ') to an attribute'),
#              tags$li('Recoding (mapping a set of attributes onto a new set)'),
#              tags$li('Conditional transformations (', code('do...if...'),')'))
#            #uiOutput('modifyattrchooser')
#            )
#          )
  )
),

column(4,
tabsetPanel(
  tabPanel('Data Summary', br(),
           verbatimTextOutput('ACMsum')
           ))
  )
),

icon('question-circle', class='fa-2x helper-btn'),
div(class="helper-box", style="display:none",
    p('Upload a file of all-cause mortality data. The data should be a *.csv file',
    'saved from the WHO standardized Excel template. Click', a("here",
      href = "https://www.who.int/westernpacific/", target = "_blank"), ' to download.')),
actionLink('dataleft', icon=icon('arrow-left', class='fa-2x'), label=NULL),
actionLink('dataright', icon=icon('arrow-right', class='fa-2x'), label=NULL)
),


# Network Descriptives ----------------------------------------------------

# There are no calls to selectInput for the options to color code or size the nodes,
# even though they appear in the app. Most widget functions are called in ui.R, but
# this means that all the options passed to them must be static. If the options depend
# on user input (the coloring and sizing menus depend on which network the user
# selects), the widget must be rendered in server.R and output in ui.R with
# iuOutput.

tabPanel(title='Plots', value='tab3',
 #include progress box when this tab is loading
 div(class = "busy",
     p("Calculation in progress..."),
     img(src="ajax-loader.gif")
 ),

fluidRow(
 column(2,
    tabsetPanel(id='plottabs',
      tabPanel('All Cause Mortality Plot',
               p(class='helper', id='ACMplothelper', icon('question-circle')),
               div(class='mischelperbox', id='ACMplothelperbox',
                   "Degrees are a node level measure for the number of edges incident on each node.",
                   "The degree distribution shows how the edges in a network are distributed among the",
                   "nodes. The amount (or proportion) of nodes with low, medium",
                   "or high degrees contribute to the overall structure of the",
                   "network. The degree distributions of directed graphs can",
                   "be subset by in-degree or out-degree."),
                plotOutput('ACMplot', click = "plot_click",
                           dblclick = dblclickOpts(id = "plot_dblclick"),
                           hover = hoverOpts(id = "plot_hover", delay = 100,
                                             delayType = "throttle"),
                           brush = brushOpts(id = "plot_brush")
                           )
        )
#     tabPanel('Excess Cause Mortality Plot',
#              p(class='helper', id='EMplothelper', icon('question-circle')),
#              div(class='mischelperbox', id='EMplothelperbox',
#                  "Degrees are a node level measure for the number of edges incident on each node.",
#                  "The degree distribution shows how the edges in a network are distributed among the",
#                  "nodes. The amount (or proportion) of nodes with low, medium",
#                  "or high degrees contribute to the overall structure of the",
#                  "network. The degree distributions of directed graphs can",
#                  "be subset by in-degree or out-degree."),
#               plotOutput('ACMplot', click = "plot_click",
#                          dblclick = dblclickOpts(id = "plot_dblclick"),
#                          hover = hoverOpts(id = "plot_hover", delay = 100,
#                                            delayType = "throttle"),
#                          brush = brushOpts(id = "plot_brush")
#                          )
#       )
      ),br(),br()
),
 ),
div(id='plottabhelp', class='helper-btn', icon('question-circle', 'fa-2x')),
 div(class="helper-box", style="display:none",
     p('Use the network plots to gain insight to the observed network.',
       'Edit the display options in the panel on the right and download a PDF of any of the plots.')),
actionLink('plotleft', icon=icon('arrow-left', class='fa-2x'), label=NULL),
actionLink('plotright', icon=icon('arrow-right', class='fa-2x'), label=NULL)
),

# Expected Deaths --------------------------------------------------------------------

tabPanel(title='Expected Deaths',  value='tab4',

         #include progress bar when this tab is loading
         div(class = "busy",
             p("Calculation in progress... This might take a few minutes."),
             img(src="ajax-loader.gif")
         ),

    dataTableOutput("spline_table")
##   DT::dataTableOutput("iris_table")
),

# Methods --------------------------------------------------------------------

tabPanel(title='Methods', value='tab5',
   column(6, style="padding: 0 30px 0 0;",
          div(id="methodsbox",
            p("This page has a description of the statistical methods used in the calculator to compute the expected and excess deaths in countries"),

            p(strong("Negative-binomial regression")),

            p("This particular negative-binomial regression model is a generalized additive model (GAM) in that it uses smoothing functions",
              "for the predictor variables. Since the date and period are input as discrete values, they are smoothed using cubic splines,",
              "a common smoothing technique."),

            p(strong("Historical 5-years average")),

            p("The 5-years historical average is calculated based on and their 95% confidence interval (95% CI) are calculated",
              "from the deaths observed in 2015-2019. The excess deaths are calculated as the difference of all-causes deaths in",
              "2020 to the historical average."),

            p("Below is a detailed description of the methods in statistical language. It is in PDF format and can be saved for separate
study."),
          ),
         tags$iframe(style="height:400px; width:100%; scrolling=yes", 
                   src="ACMnotes_201230.pdf")
         )
         ),

tabPanel(title='Help', value='tab6',
         sidebarLayout(position = 'right',
                       sidebarPanel(
                         h5(tags$u('Resources')),
                         div(title = "Wiki page for WPROACM",
                             a("About WPROACM",
                               href = "https://github.com/handcock/WPROACM/wiki",
                               target = "_blank")),
                         div(title=paste("Information on the methodology used",
                                         "in the tool"),
                             a("About the methodology used in the tool.",
                               href = "https://github.com/handcock/WPROACM/wiki/Methodology-used-in-WPROACM/", target = "_blank")
                         ),
                         br(),
                         div(a("WPROACM on GitHub", href="https://github.com/handcock/WPROACM",
                               target="_blank")),
                         div(a("Shiny: a web application framework for R", href="http://shiny.rstudio.com/",
                               target="_blank"))
                       ),
                       mainPanel(
                         h5(tags$u('Help with WPROACM')),
                         p("This app is maintained on GitHub. To request new features or report a bug,",
                           "please interact with the",
                           a("repository", href='https://github.com/handcock/WPROACM',
                             target="_blank"),
                           "or email us at", 
                             a(actionButton(inputId = "email1", label = "handcock@stat.ucla.edu", 
                               icon = icon("envelope", lib = "font-awesome")),
                               href="mailto:handcock@stat.ucla.edu"))
                         ))
         )


  )
)
